<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario - El Tornillo Feliz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Toastr CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />

</head>
<body class="bg-light">

    <div class="container mt-5">
        <h1 class="text-center mt-4 text-success">
            <i class="bi bi-box-seam"></i> Inventario de Productos
        </h1>
    
        <!-- üîî Alerta de bajo stock -->
        <div id="alertaStock"></div>
    
        <div class="mb-3">
          <a href="agregar.html" class="btn btn-primary">‚ûï Agregar Producto</a>
          <button class="btn btn-warning ms-2" onclick="mostrarBajoStock()">‚ö†Ô∏è Bajo Stock</button>
        </div>
    
        <div id="mensaje" class="mb-3"></div>
    
        <table class="table table-hover table-bordered bg-white shadow-sm">
          <thead class="table-dark">
            <tr>
              <th>C√≥digo</th>
              <th>Nombre</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaProductos">
            <!-- Se cargan desde JS -->
          </tbody>
        </table>
    </div>
    
    <script>
        const tabla = document.getElementById("tablaProductos");
        const mensaje = document.getElementById("mensaje");
        const alertaStock = document.getElementById("alertaStock");
    
        async function cargarProductos(api = "http://localhost:8080/api/productos") {
          tabla.innerHTML = "";
          const res = await fetch(api);
          const productos = await res.json();
    
        if (!productos.length) {
            tabla.innerHTML = `<tr><td colspan="5" class="text-center">ü´• No hay productos registrados.</td></tr>`;
            return;
        }
    
        productos.forEach(p => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
              <td>${p.codigo}</td>
              <td>${p.nombre}</td>
              <td class="${p.cantidad <= 5 ? 'text-danger fw-bold' : ''}">${p.cantidad}</td>
              <td>$${p.precioUnitario.toFixed(2)}</td>
              <td>
                <a href="editar.html?id=${p.id}" class="btn btn-sm btn-outline-primary">‚úèÔ∏è Editar</a>
                <button onclick="eliminarProducto('${p.id}')" class="btn btn-sm btn-outline-danger ms-1">üóëÔ∏è Eliminar</button>
              </td>
            `;
            tabla.appendChild(fila);
        });
        }
    
        async function eliminarProducto(id) {
          if (confirm("¬øEst√°s seguro de que quer√©s eliminar este producto? üßê")) {
            const res = await fetch(`http://localhost:8080/api/productos/${id}`, { method: "DELETE" });
            const msg = await res.text();
            mensaje.innerHTML = `<div class="alert alert-info">${msg}</div>`;
            cargarProductos();
            verificarBajoStock(); // üîÅ volvemos a revisar el stock
          }
        }
    
        function mostrarBajoStock() {
          cargarProductos("http://localhost:8080/api/productos/bajo-stock");
        }
    
        async function verificarBajoStock() {
          const res = await fetch("http://localhost:8080/api/productos/bajo-stock");
          const bajoStock = await res.json();
    
          if (bajoStock.length > 0) {
            alertaStock.innerHTML = `
              <div class="alert alert-warning shadow-sm">
                ‚ö†Ô∏è <strong>${bajoStock.length}</strong> producto${bajoStock.length > 1 ? 's' : ''} con bajo stock. ¬°Revis√° el inventario!
              </div>
            `;
          } else {
            alertaStock.innerHTML = "";
          }
        }
    
        cargarProductos();
        verificarBajoStock(); // ‚úÖ ejecutamos la alerta al iniciar
    </script>

    <!-- jQuery (necesario para Toastr) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        window.addEventListener('DOMContentLoaded', async () => {
          try {
            const res = await fetch('http://localhost:8080/api/productos/bajo-stock');
            const productos = await res.json();
      
            if (productos.length > 0) {
              toastr.warning(`‚ö†Ô∏è Hay ${productos.length} producto(s) con bajo stock.`, 'Alerta de inventario', {
                timeOut: 5000,
                progressBar: true,
                closeButton: true,
                positionClass: 'toast-top-right'
              });
            }
          } catch (err) {
            console.error("Error al obtener productos con bajo stock", err);
          }
        });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetch("http://localhost:8080/api/productos")
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector("tbody");
          data.forEach(producto => {
            const fila = document.createElement("tr");

            const tdCodigo = document.createElement("td");
            tdCodigo.textContent = producto.codigo;

            const tdNombre = document.createElement("td");
            tdNombre.textContent = producto.nombre;

            const tdCantidad = document.createElement("td");
            tdCantidad.textContent = producto.cantidad;

            const tdPrecio = document.createElement("td");
            tdPrecio.textContent = producto.precio;

            const tdAcciones = document.createElement("td");
            tdAcciones.innerHTML = `
            <a href="editar.html?codigo=${producto.codigo}" class="btn btn-sm btn-warning me-2">‚úèÔ∏è Editar</a>
            <button class="btn btn-sm btn-danger" onclick="eliminarProducto('${producto.codigo}')">üóëÔ∏è Eliminar</button>
            `;

            fila.appendChild(tdCodigo);
            fila.appendChild(tdNombre);
            fila.appendChild(tdCantidad);
            fila.appendChild(tdPrecio);
            fila.appendChild(tdAcciones);

          tbody.appendChild(fila);
          });
        });
      });

      function eliminarProducto(codigo) {
        if (confirm("¬øEst√°s seguro de que quer√©s eliminar este producto? üò±")) {
          fetch(`http://localhost:8080/api/productos/${codigo}`, {
          method: "DELETE"
          })
          .then(res => { 
          if (res.ok) {
            alert("üóëÔ∏è Producto eliminado correctamente");
            location.reload();
          } else {
            alert("‚ùå No se pudo eliminar el producto");
          }
          });
        }
      }
    </script>

</body>
</html>
